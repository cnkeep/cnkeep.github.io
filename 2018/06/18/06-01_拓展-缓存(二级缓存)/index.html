<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="聚沙成塔"><title>01_拓展-缓存(二级缓存) | Mr.Zhang's Blog</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.3"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.3"></script><script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.3"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">01_拓展-缓存(二级缓存)</h1><a id="logo" href="/.">Mr.Zhang's Blog</a><p class="description">奋斗者~</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><search-result></search-result></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">01_拓展-缓存(二级缓存)</h1><div class="post-meta"><a href="/2018/06/18/06-01_拓展-缓存(二级缓存)/#comments" class="comment-count"></a><p><span class="date">06月18日, 2018</span><span><a href="/categories/Mybatis/" class="category">Mybatis</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="拓展-缓存-二级缓存"><a href="#拓展-缓存-二级缓存" class="headerlink" title="拓展-缓存(二级缓存)"></a>拓展-缓存(二级缓存)</h2><blockquote>
<p>目录  </p>
<blockquote>
<ul>
<li><a href="#前言">前言</a>  </li>
<li><a href="#二级缓存">正文</a>  <blockquote>
<ul>
<li><a href="#使用二级缓存">使用二级缓存</a>  </li>
<li><a href="#二级缓存原理分析">二级缓存原理分析</a>  </li>
<li><a href="#二级缓存的生命周期">二级缓存的生命周期</a>  </li>
</ul>
</blockquote>
</li>
<li><a href="#总结">总结</a>  </li>
</ul>
</blockquote>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>上节我们针对一级缓存的原理做了探究，本节我们就一起来探究一下二级缓存。  </p>
</blockquote>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><h3 id="使用二级缓存"><a href="#使用二级缓存" class="headerlink" title="使用二级缓存"></a>使用二级缓存</h3><blockquote>
<p>在<a href="03-mybatis-config.xml的配置介绍.md">mybatis配置文件分析</a>中介绍过缓存的配置<br>1.mapper-config.xml配置开启二级缓存<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    		<span class="comment">&lt;!-- 打印查询语句--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"STDOUT_LOGGING"</span> /&gt;</span></span><br><span class="line">    		<span class="comment">&lt;!-- 二级缓存,默认true --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    	<span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mapper/UserMapper.xml"</span> /&gt;</span></span><br><span class="line">    	<span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">&gt; 2.在Mybatis的映射XML中配置cache或者 cache-ref 。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<pre><code>&lt;cache/&gt; 
或
&lt;cache-ref namespace=&quot;mapper.UserMapper&quot;/&gt;
</code></pre><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cache标签用于声明这个namespace使用二级缓存，并且可以自定义配置。  </span><br><span class="line"><span class="bullet">* </span>type: cache使用的类型，默认是PerpetualCache，这在一级缓存中提到过。  </span><br><span class="line"><span class="bullet">* </span>eviction: 定义回收的策略，常见的有FIFO，LRU。  </span><br><span class="line"><span class="bullet">* </span>flushInterval: 配置一定时间自动刷新缓存，单位是毫秒  </span><br><span class="line"><span class="bullet">* </span>size: 最多缓存对象的个数  </span><br><span class="line"><span class="bullet">* </span>readOnly: 是否只读，若配置可读写，则需要对应的实体类能够序列化。  </span><br><span class="line"><span class="bullet">* </span>blocking: 若缓存中找不到对应的key，是否会一直blocking，直到有对应的数据进入缓存。  </span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 3.测试使用</span></span><br></pre></td></tr></table></figure>
<pre><code>@Test
public void mapperTest() {
    SqlSessionFactory sqlSessionFactory = application.getBean(SqlSessionFactory.class);
    SqlSession sqlSession = sqlSessionFactory.openSession();
    SqlSession sqlSession1 = sqlSessionFactory.openSession();
    try {
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        UserMapper userMapper1 = sqlSession1.getMapper(UserMapper.class);
        User user = userMapper.getById(&quot;4f98966b-f7a9-401c-b327-aa0e401d47b4&quot;);
        //sqlSession.commit();
        User user1 = userMapper1.getById(&quot;4f98966b-f7a9-401c-b327-aa0e401d47b4&quot;);
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        sqlSession.close();
    }
}
</code></pre><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line">执行发现报错：  </span><br><span class="line">![二级缓存需要实体序列化](images/two_level_cache_exception.png)   </span><br><span class="line">发现是因为二级缓存实体需要实现序列化，实现序列化后发现缓存没有生效，神奇了  </span><br><span class="line"></span><br><span class="line">![二级缓存失效的错误](images/two_level_cache_invalid.png)    </span><br><span class="line">最后发现是因为第一个事务没有``commit``导致的，修改代码先提交事务<span class="number">1</span>，再查询事务<span class="number">2</span>，发现二级缓存生效，至于为什么要commit，先留个悬念，后面分析原理再说明   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">### 二级缓存原理分析   </span></span><br><span class="line">Mybatis二级缓存的工作流程和前文提到的一级缓存类似，只是在一级缓存处理前，用CachingExecutor装饰了BaseExecutor的子类，实现了缓存的查询和写入功能。   </span><br><span class="line">![CachingExecutor装饰Executor](images/create_cachingExecutor.png)  </span><br><span class="line"></span><br><span class="line">&gt; 来看``CachingExecutor``类，这是一个装饰者模式的应用      </span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CachingExecutor</span> <span class="title">implements</span> <span class="title">Executor</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> Executor <span class="keyword">delegate</span>;<span class="comment">//装饰的对象</span></span><br><span class="line">      <span class="comment">//管理缓存</span></span><br><span class="line">      <span class="keyword">private</span> TransactionalCacheManager tcm = <span class="keyword">new</span> TransactionalCacheManager();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">/***</span></span><br><span class="line"><span class="comment">      * 部分方法代码已经省略，这里只关注重要的方法....</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">CachingExecutor</span>(<span class="params">Executor <span class="keyword">delegate</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">delegate</span> = <span class="keyword">delegate</span>;</span><br><span class="line">        <span class="keyword">delegate</span>.setExecutorWrapper(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span>(<span class="params">boolean forceRollback</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//是否回滚缓存</span></span><br><span class="line">          <span class="keyword">if</span> (forceRollback) &#123; </span><br><span class="line">            tcm.rollback();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tcm.commit();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">delegate</span>.close(forceRollback);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span>(<span class="params">MappedStatement ms, Object parameterObject</span>) throws SQLException</span> &#123;</span><br><span class="line">        <span class="comment">// 清除二级缓存</span></span><br><span class="line">        flushCacheIfRequired(ms);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">delegate</span>.update(ms, parameterObject);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span>(<span class="params">MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler</span>) throws SQLException</span> &#123;</span><br><span class="line">        BoundSql boundSql = ms.getBoundSql(parameterObject);</span><br><span class="line">        CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">        <span class="keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span>(<span class="params">MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql</span>)</span></span><br><span class="line"><span class="function">          throws SQLException</span> &#123;</span><br><span class="line">        Cache cache = ms.getCache();</span><br><span class="line">        <span class="keyword">if</span> (cache != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">/*根据Mapper.xml中sql节点配置的flushCache属性(select默认为false)判断是否需要清空缓存*/</span></span><br><span class="line">          flushCacheIfRequired(ms);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">/*根据Mapper.xml中sql节点配置的useCache属性(select默认为true)判断是否需要缓存查询结果*/</span></span><br><span class="line">          <span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">            ensureNoOutParams(ms, parameterObject, boundSql);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//查询缓存</span></span><br><span class="line">            List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="literal">null</span>) &#123;</span><br><span class="line">              list = <span class="keyword">delegate</span>.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">              tcm.putObject(cache, key, list); <span class="comment">// issue #578 and #116</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">delegate</span>.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span>(<span class="params">boolean required</span>) throws SQLException</span> &#123;</span><br><span class="line">        <span class="comment">/*提交事务*/</span></span><br><span class="line">        <span class="keyword">delegate</span>.commit(required);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*保存缓存，这就是为什么多个session必须提交之后缓存才生效的原因*/</span></span><br><span class="line">        tcm.commit();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span>(<span class="params">boolean required</span>) throws SQLException</span> &#123;</span><br><span class="line">        <span class="comment">/*事务和缓存同时回滚*/</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">delegate</span>.rollback(required);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (required) &#123;</span><br><span class="line">            tcm.rollback();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> CacheKey <span class="title">createCacheKey</span>(<span class="params">MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">delegate</span>.createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearLocalCache</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">/*清除一级缓存 */</span></span><br><span class="line">        <span class="keyword">delegate</span>.clearLocalCache();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushCacheIfRequired</span>(<span class="params">MappedStatement ms</span>)</span> &#123;</span><br><span class="line">        Cache cache = ms.getCache();</span><br><span class="line">        <span class="comment">/*select默认为flushCache=false; update,delete为false. 即修改操作会清除缓存*/</span></span><br><span class="line">        <span class="keyword">if</span> (cache != <span class="literal">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;      </span><br><span class="line">          tcm.clear(cache);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line">通过对原有的Executor执行器做装饰来实现缓存的功能  </span><br><span class="line"></span><br><span class="line">&gt; 我们重点来看``TransactionalCacheManager``类  </span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TransactionalCacheManager</span> &#123;</span><br><span class="line">      <span class="comment">//利用map来临时存储缓存</span></span><br><span class="line">      <span class="keyword">private</span> Map&lt;Cache, TransactionalCache&gt; transactionalCaches = <span class="keyword">new</span> HashMap&lt;Cache, TransactionalCache&gt;();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">/***</span></span><br><span class="line"><span class="comment">      * 这里只给出部分源代码....</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span>(<span class="params">Cache cache, CacheKey key, Object <span class="keyword">value</span></span>)</span> &#123;</span><br><span class="line">        getTransactionalCache(cache).putObject(key, <span class="keyword">value</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">          txCache.commit();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;</span><br><span class="line">          txCache.rollback();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">private</span> TransactionalCache <span class="title">getTransactionalCache</span>(<span class="params">Cache cache</span>)</span> &#123;</span><br><span class="line">        TransactionalCache txCache = transactionalCaches.<span class="keyword">get</span>(cache);</span><br><span class="line">        <span class="keyword">if</span> (txCache == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">//对Cache重新包装为TransactionalCache,可以像事务一样的操作缓存</span></span><br><span class="line">          txCache = <span class="keyword">new</span> TransactionalCache(cache);</span><br><span class="line">          transactionalCaches.put(cache, txCache);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> txCache;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">```  </span><br><span class="line">&gt; ``TransactionlCache``类，它提供了类似于事务操作的方式来操作缓存    </span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TransactionalCache</span> <span class="title">implements</span> <span class="title">Cache</span> &#123;</span><br><span class="line">      <span class="comment">//装饰源对象</span></span><br><span class="line">      <span class="keyword">private</span> Cache <span class="keyword">delegate</span>;</span><br><span class="line">      <span class="comment">//用于标示是否提交时先清除缓存</span></span><br><span class="line">      <span class="keyword">private</span> boolean clearOnCommit;</span><br><span class="line">      <span class="comment">//临时缓存区，存储待提交的缓存信息</span></span><br><span class="line">      <span class="keyword">private</span> Map&lt;Object, Object&gt; entriesToAddOnCommit;</span><br><span class="line">      <span class="keyword">private</span> Set&lt;Object&gt; entriesMissedInCache;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">TransactionalCache</span>(<span class="params">Cache <span class="keyword">delegate</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">delegate</span> = <span class="keyword">delegate</span>;</span><br><span class="line">        <span class="keyword">this</span>.clearOnCommit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.entriesToAddOnCommit = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">        <span class="keyword">this</span>.entriesMissedInCache = <span class="keyword">new</span> HashSet&lt;Object&gt;();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span>(<span class="params">Object key</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// issue #116</span></span><br><span class="line">        Object <span class="keyword">object</span> = <span class="keyword">delegate</span>.getObject(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">object</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">          entriesMissedInCache.<span class="keyword">add</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// issue #146</span></span><br><span class="line">        <span class="keyword">if</span> (clearOnCommit) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">object</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      @Override</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putObject</span>(<span class="params">Object key, Object <span class="keyword">object</span></span>)</span> &#123;</span><br><span class="line">        entriesToAddOnCommit.put(key, <span class="keyword">object</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">//提交缓存，即确认缓存信息需要保存</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (clearOnCommit) &#123;</span><br><span class="line">          <span class="keyword">delegate</span>.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        flushPendingEntries();</span><br><span class="line">        reset();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        unlockMissedEntries();</span><br><span class="line">        reset();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reset</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        clearOnCommit = <span class="literal">false</span>;</span><br><span class="line">        entriesToAddOnCommit.clear();</span><br><span class="line">        entriesMissedInCache.clear();</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">//将缓存信息放入最终缓存区</span></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushPendingEntries</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : entriesToAddOnCommit.entrySet()) &#123;</span><br><span class="line">          <span class="keyword">delegate</span>.putObject(entry.getKey(), entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Object entry : entriesMissedInCache) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!entriesToAddOnCommit.containsKey(entry)) &#123;</span><br><span class="line">            <span class="keyword">delegate</span>.putObject(entry, <span class="literal">null</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlockMissedEntries</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object entry : entriesMissedInCache) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">delegate</span>.removeObject(entry);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(<span class="string">"Unexpected exception while notifiying a rollback to the cache adapter."</span></span><br><span class="line">                + <span class="string">"Consider upgrading your cache adapter to the latest version.  Cause: "</span> + e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们看到<code>TransactionalCacheManager</code>和<code>TransactionalCache</code>组合提供了类似事务操作的方式来控制缓存的功能,当然mybatis不可能止步于此，它做的更深入：二级缓存使用了装饰器模式优雅的做了很多事情，如图：    </p>
</blockquote>
<p><img src="/2018/06/18/06-01_拓展-缓存(二级缓存)/images/two_level_cache.png" alt="二级缓存的装饰器模式结构">  </p>
<blockquote>
<p>装饰类的执行链：SynchroinzedCache -&gt; LoggingCache -&gt; SerializedCache -&gt; LruCache -&gt; PerpetualCache，来看看每个装饰器都是什么功能：  </p>
<ul>
<li>SynchronizedCache: 同步的方式操作Cache，实现比较简单，直接使用synchronized修饰方法。  </li>
<li>LoggingCache: 日志功能，装饰类，用于记录缓存的命中率，如果开启了DEBUG模式，则会输出命中率日志。  </li>
<li>SerializedCache: 序列化功能，将值序列化后存到缓存中。该功能用于缓存返回一份实例的Copy，用于保存线程安全。  </li>
<li>LruCache: 采用了Lru算法实现（内部使用LinkedHashMap实现），移除最近最少使用的缓存。  </li>
<li>PerpetualCache: 作为最基础的缓存类，底层实现比较简单，直接使用了HashMap来存储数据。  </li>
</ul>
</blockquote>
<h3 id="二级缓存的生命周期"><a href="#二级缓存的生命周期" class="headerlink" title="二级缓存的生命周期"></a>二级缓存的生命周期</h3><blockquote>
<p>上面我们说到二级缓存采用了装饰器模式，其中存在LruCache装饰器，该装饰器就管理着我们的缓存有效性，所以从理论上讲二级缓存属于应用级别的。<br>此外，二级缓存虽然可以在不同SqlSession之间共享缓存，但是还是有限制的，因为cache的作用域为同一个namespace，即在同一个namespace下才使用<br>相同的缓存，不同的namespace使用的是不同的缓存。这样在多表级联且在多个namespace下时存在脏数据，实际上达到不能共享缓存的目的，<br>我们可以使用cache-ref指定相同的namespace（不建议这么做）。<br>同样的insert,update,delete操作时会清除原有缓存  </p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>二级缓存的执行时流程：  </p>
<blockquote>
<ul>
<li>根据配置生成包装的CachingExecutor来增强executor的功能  </li>
<li>当sqlSession委托executor执行器执行查询时，判断是否存在缓存  <blockquote>
<ul>
<li>存在时，判断是否开启了二级缓存，开启的话，获取具体的缓存信息，如果存在就直接返回; 不存在就查库并放入临时缓存区  </li>
<li>不存在，直接查库(理论上配置开启了二级缓存是不会出现这种情况的)    </li>
</ul>
</blockquote>
</li>
<li>提交事务，临时缓存真正存储到二级缓存区  </li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p>二级缓存的特点：  </p>
<ul>
<li>Mybatis二级缓存是基于namespace的，同一个namespace下的属于同一个缓存，不同的namespace使用不同的缓存，但是可以通过cache-ref解决。  </li>
<li>Mybatis二级缓存的生命周期与应用一致，存储在Configuration中(实际在MappedStatement中两者是一样的)，失效清理策略可自行配置失效策略，默认是LRU。  </li>
<li>Mybatis二级缓存的实体对象需要序列化。  </li>
<li>Mybatis二级缓存是一个粗粒度的缓存，可以实现在不同sqlsession之间共享缓存。  </li>
<li>Mybatis的二级缓存在多表查询时，极大可能会出现脏数据，有设计上的缺陷，且在分布式环境下因为默认缓存是在本地，必然会读到脏数据，还不容使用其他类似redis,memcache来的好些。  </li>
</ul>
</blockquote>
<blockquote>
<p>一二级缓存的处理流程：<br><img src="/2018/06/18/06-01_拓展-缓存(二级缓存)/images/cache_deal_theory.png" alt="缓存的处理流程"></p>
</blockquote>
</div><div class="post-copyright"><blockquote><p>原文作者: LeiLi.Zhang</p><p>原文链接: <a href="https://cnkeep.github.io/2018/06/18/06-01_拓展-缓存(二级缓存)/">https://cnkeep.github.io/2018/06/18/06-01_拓展-缓存(二级缓存)/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/Mybatis/">Mybatis</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2018/06/20/06-02_拓展-插件(Plugin)/" class="pre">02_拓展-插件(Plugin)</a><a href="/2018/06/18/06-01_拓展-缓存(一级缓存)/" class="next">01_拓展-缓存(一级缓存)</a></div><div id="comments"><div id="container"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.3"><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.3"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.3"></script><script>var gitalk = new Gitalk({
  clientID: '5b6acb94829bddd4a4b2',
  clientSecret: '718d07f690aa6efee404a48e1ffc762276be4d4a',
  repo: 'cnkeep.github.io',
  owner: 'cnkeep',
  admin: ['cnkeep'],
  id: md5(window.location.pathname),
  distractionFreeMode: false,
  language: 'zh-CN',
  pagerDirection: 'last'
})
gitalk.render('container')</script></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#拓展-缓存-二级缓存"><span class="toc-number">1.</span> <span class="toc-text">拓展-缓存(二级缓存)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二级缓存"><span class="toc-number">3.</span> <span class="toc-text">二级缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用二级缓存"><span class="toc-number">3.1.</span> <span class="toc-text">使用二级缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二级缓存的生命周期"><span class="toc-number">3.2.</span> <span class="toc-text">二级缓存的生命周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/05/02-JVM参数配置打印gc日志/">JVM参数配置打印gc日志</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/05/02-jstack命令/">jstack命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/03/01-Jconsole无法连接程序/">Jconsole无法连接程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/02/01-jps命令/">jps命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/看懂UML类图/">看懂UML类图</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/03-Redis设置开机自启/">Redis设置开机自启</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/02-Redis设置访问ip限制/">Redis设置访问ip限制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/01-Redis介绍与安装/">Redis介绍与安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/10/04-explain查看执行计划/">explain查看执行计划</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/08/03-02_Mysql执行顺序/">02_Mysql执行顺序</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/UML/">UML</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bugs/">bugs</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/others/">others</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">6</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/bugs/" style="font-size: 15px;">bugs</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/others/" style="font-size: 15px;">others</a> <a href="/tags/UML/" style="font-size: 15px;">UML</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://github.com/cnkeep" title="Github" target="_blank">Github</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">LeiLi.Zhang.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>